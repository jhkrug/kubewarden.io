name: 'docs: update Kubewarden version on frontpage of kubewarden.io
pipelineid: kubewarden-controller/latest

actions:
  default:
    title: 'docs: update Kubewarden version to {{ source "kubewarden-controller-version" }}'
    kind: github/pullrequest
    scmid: default
    spec:
      automerge: false
      mergemethod: squash
      labels:
        - chore

scms:
  default:
    kind: github
    spec:
      user: kubewarden-bot
      email: bot@kubewarden.io
      owner: kubewarden
      repository: kubewarden.io
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      branch: updcli-kw-ver

sources:
  kubewarden-controller-version:
    name: Get latest Kubewarden version
    kind: githubrelease
    spec:
      owner: kubewarden
      repository: kubewarden-controller
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      versionfilter:
        kind: semver
        # We want to ignore pre-release version
        # According the library documentation used by updatecli
        # https://github.com/Masterminds/semver#working-with-prerelease-versions
        # the following rule, should do the trick
        pattern: ">0.1"

targets:
  kw-latest-version-number:
    name: 'docs: update Kubewarden with version {{ source "kubewarden-controller-version" }}'
    kind: file
    spec:
      file: content/_index.html
      matchpattern: '<a href="get-started">(.*)</a>'
      replacepattern: '<a href="#get-started">{{ source "kubewarden-controller-version" }}</a>'
    scmid: default
    sourceid: kubewarden
